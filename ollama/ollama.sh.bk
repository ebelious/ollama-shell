#!/usr/bin/env bash
CONFIG=$HOME/.config/ollama/ollama.conf
D_SERVER=$(cat $CONFIG | grep server | sed "s/\"//g"| cut -d '=' -f2)
D_MODEL=$(cat $CONFIG | grep model | sed "s/\"//g"| cut -d '=' -f2)
L_MODEL=$HOME/.config/ollama/ollama_pullable.txt
# Get and Set Ollama server
fn_server(){
clear
read -p "Enter Ollama Server: 'example: 10.1.1.6 or localhost'" IP
SERVER="OLLAMA_HOST=http://$IP:11434"
export $SERVER
sed -i "s/server=.*$/server="$IP"/g" $CONFIG
}

# Get and Select LLms from Server
fn_llms(){ 
clear
LIST=($(ollama ls | awk 'NR>=2 {print $1}' | sort ))
if [ ${#LIST[@]} -eq 0 ];then
    echo -e "\e[31mCannot find Models\e[0m"
    exec "$0"
fi
# Get The Numbers
echo -e "\e[33m[Models]\e[0m \e[32m[Select]\e[0m"
echo
for i in "${!LIST[@]}"; do
     echo -e "\e[33m[$((i+1))]\e[0m ${LIST[$i]}"
done
# Selection Statment
echo 
read -p "Select the modelw number: " OPTION
if [[ "$OPTION" != "Q" && "$OPTION" != "q" ]] && { [[ ! "$OPTION" =~ ^[0-9]+$ ]] || [ "$OPTION" -lt 1 ] || [ "$OPTION" -gt "${#LIST[0]}" ]; }; then
    echo -e "\e[31mInvalid Selection\e[0m"
    sleep 1
    exec "$0"
fi
SELECTED=${LIST[$((OPTION -1))]}
sed -i "s/model=.*$/model="$SELECTED"/g" $CONFIG
}

fn_pull(){
$PULL=$(cat $L_MODEL | fzf)
export $URL  ollama pull $PULL
}


fn_spin(){
spinn=( '\\' '|' '/' '-' )
while [ 1 ] ;do
    for i in "${spinn[@]}";do
        setterm -cursor off
        echo -ne "\e[0;32m[\e[0m\e[0;36m$i\e[0m\e[0;32m]\e[0m \e[36mUpdating List\e[0m\r "
        sleep 0.175
    done
 done

}

# This will curl the ollama library and remove any unwanted items in the list
fn_update() {
fn_spin & pid=$!
curl -s https://ollama.com/library \
| grep -oP 'href="/library/\K[^"/]+' \
| sort -u \
| while read -r model; do
# Attempt to find sizes mentioned near the model name in descriptions
    curl -s "https://ollama.com/library/$model" 2>/dev/null \
    | grep -oE '(8B|70B|405B|671B|[0-9]+\.?[0-9]*[BMK])' \
    | sort -u \
    | sed "s/B$/b/; s/M$/m/; s/^/$model:/" 2>/dev/null
    done \
    | sort -u > ollama_pullable.txt
sed -i '/[mkMK]$/d' $L_MODEL &>/dev/null
kill $pid
echo -ne "\e[32mDone Updating List\e[0m"
sleep 2
setterm -cursor on
}


fn_delete(){ 
clear
LIST=($(ollama ls | awk 'NR>=2 {print $1}' | sort ))
if [ ${#LIST[@]} -eq 0 ];then
    echo -e "\e[31mCannot find Models\e[0m"
    exec "$0"
fi
# Get The Numbers
echo -e "\e[33m[Models]\e[0m \e[31m[Delete]\e[0m"
echo
for i in "${!LIST[@]}"; do
     echo -e "\e[33m[$((i+1))]\e[0m ${LIST[$i]}"
done
# Selection Statment
echo 
read -p "Select the model number: " OPTION
if [[ "$OPTION" != "Q" && "$OPTION" != "q" ]] && { [[ ! "$OPTION" =~ ^[0-9]+$ ]] || [ "$OPTION" -lt 1 ] || [ "$OPTION" -gt "${#LIST[0]}" ]; }; then
    echo -e "\e[31mInvalid Selection\e[0m"
    sleep 1
    exec "$0"
fi

SELECTED=${LIST[$((OPTION -1))]}
ollama rm $SELECTED
exec "$0"
}

fn_nodef(){
clear
fn_server
clear
fn_llms
clear
ollama run $SELECTED
}

#
fn_center() {                                                                            
local cols text
cols=$(tput cols)
while IFS= read -r text; do
printf "%*s\n" $(((${#text} + cols) / 2)) "$text"
done
}

# Menu and Formatting
URL="OLLAMA_HOST=http://$D_SERVER:11434"
export $URL
clear
echo
echo -e "\e[34m[Current]\e[0m" | fn_center
echo
echo -e "\e[033mServer:\e[0;m$D_SERVER\e[0m\n\e[33mModel:\e[0m$D_MODEL" | column | fn_center
echo
printf '=%.0s' $(seq 1 $(tput cols))
echo
echo
echo -e "\e[33m[Y]\e[0m  Use Current"
echo -e "\e[33m[S]\e[0m  Set New Server"
echo -e "\e[33m[M]\e[0m  Set Sew Model"
echo -e "\e[33m[P]\e[0m  Pull Model"
echo -e "\e[33m[U]\e[0m  Update Model List"
echo -e "\e[33m[D]\e[0m  Delete Model"
echo
read -p "Use Current?  " DEF
echo
case "$DEF" in
    Y|y) ollama run $D_MODEL;;
    S|s) fn_server && exec "$0";;
    M|m) fn_llms && exec "$0";;
    P|p) fn_pull && exec "$0";;
    U|u) fn_update && exec "$0";;
    D|d) fn_delete && exec "$0";;  
      *) "$0";; 
esac
